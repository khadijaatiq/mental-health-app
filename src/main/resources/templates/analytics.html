<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Analytics - MindTrack</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/users.css">
</head>

<body>
<nav class="navbar">
    <div class="logo">MindTrack</div>
    <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/mood">Mood</a>
        <a href="/journal">Journal</a>
        <a href="/goals">Goals</a>
        <a href="/analytics">Analytics</a>
        <a href="/export">Export</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="container">
    <div class="header">
        <h2>Your Insights</h2>
        <p style="color: var(--text-muted)">Overview of your mental wellness journey over the last 30 days.</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Avg Mood Intensity</div>
            <div class="stat-value" id="avgMood">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Stress Level</div>
            <div class="stat-value" id="avgStress">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Journal Entries</div>
            <div class="stat-value" id="totalJournals">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Goals Completed</div>
            <div class="stat-value" id="completedGoals">-</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3>Mood Distribution</h3>
            <canvas id="moodChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>Emotion Tags</h3>
            <canvas id="emotionChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>Goal Progress</h3>
            <canvas id="goalChart"></canvas>
        </div>
    </div>
</div>

<script>
    function logout() {
        document.cookie = "JWT=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = '/login';
    }

    async function loadAnalytics() {
        try {
            const response = await fetch('/api/analytics');
            if (response.ok) {
                const data = await response.json();
                updateStats(data);
                renderCharts(data);
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    function updateStats(data) {
        document.getElementById('avgMood').textContent = data.averageMoodIntensity ? data.averageMoodIntensity.toFixed(1) : '0.0';
        document.getElementById('avgStress').textContent = data.averageStressLevel ? data.averageStressLevel.toFixed(1) : '0.0';
        document.getElementById('totalJournals').textContent = data.totalJournals;
        document.getElementById('completedGoals').textContent = data.completedGoals;
    }

    function renderCharts(data) {
        // Mood Chart
        new Chart(document.getElementById('moodChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(data.moodCounts),
                datasets: [{
                    data: Object.values(data.moodCounts),
                    backgroundColor: [
                        '#818cf8', '#c084fc', '#f472b6', '#34d399', '#fbbf24', '#60a5fa'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                }
            }
        });

        // Emotion Chart
        new Chart(document.getElementById('emotionChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(data.emotionCounts),
                datasets: [{
                    label: 'Entries',
                    data: Object.values(data.emotionCounts),
                    backgroundColor: '#6366f1',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Goal Chart
        new Chart(document.getElementById('goalChart'), {
            type: 'pie',
            data: {
                labels: ['Completed', 'Pending'],
                datasets: [{
                    data: [data.completedGoals, data.pendingGoals],
                    backgroundColor: ['#34d399', '#334155'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                }
            }
        });
    }

    loadAnalytics();
</script>
</body>

</html>