<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Goals - MindTrack</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/users.css">
</head>

<body>
<nav class="navbar">
    <div class="logo">MindTrack</div>
    <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/mood">Mood</a>
        <a href="/journal">Journal</a>
        <a href="/goals">Goals</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="container">
    <div class="card">
        <h2>Set New Goal</h2>
        <form id="goalForm">
            <div class="form-group">
                <label for="title">Goal Title</label>
                <input type="text" id="title" required placeholder="e.g., Meditate daily">
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" placeholder="Details about your goal..."></textarea>
            </div>
            <div class="form-group">
                <label for="targetDate">Target Date</label>
                <input type="date" id="targetDate" required>
            </div>
            <button type="submit">Create Goal</button>
        </form>
    </div>

    <div class="card">
        <h2>My Goals</h2>
        <ul id="goalList" class="goal-list">
            <!-- Goals will be loaded here -->
        </ul>
    </div>
</div>

<script>
    function logout() {
        document.cookie = "JWT=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = '/login';
    }

    async function loadGoals() {
        try {
            const response = await fetch('/api/goals');
            if (response.ok) {
                const goals = await response.json();
                const list = document.getElementById('goalList');
                list.innerHTML = goals.map(goal => `
                        <li class="goal-item ${goal.status === 'completed' ? 'completed' : ''}">
                            <div class="goal-content">
                                <h3>${goal.title}</h3>
                                <p>${goal.description || ''}</p>
                                <div class="goal-meta">Target: ${goal.targetDate}</div>
                            </div>
                            <div class="goal-actions" style="display:flex; gap:0.5rem;">
                                ${goal.status !== 'completed' ? `<button onclick="markCompleted(${goal.id})">Complete</button>` : ''}
                                <button style="background-color: rgba(239, 68, 68, 0.2); color: #ef4444;" onclick="deleteGoal(${goal.id})">Delete</button>
                            </div>
                        </li>
                    `).join('');
            }
        } catch (error) {
            console.error('Error loading goals:', error);
        }
    }

    async function deleteGoal(id) {
        if (!confirm('Are you sure you want to delete this goal?')) return;
        try {
            const response = await fetch(`/api/goals/${id}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                loadGoals();
            }
        } catch (error) {
            console.error('Error deleting goal:', error);
        }
    }

    async function markCompleted(id) {
        try {
            const response = await fetch(`/api/goals/${id}/complete`, {
                method: 'PATCH'
            });
            if (response.ok) {
                loadGoals();
            }
        } catch (error) {
            console.error('Error updating goal:', error);
        }
    }

    document.getElementById('goalForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const targetDate = document.getElementById('targetDate').value;

        try {
            const response = await fetch('/api/goals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title, description, targetDate, status: 'pending' })
            });

            if (response.ok) {
                loadGoals();
                e.target.reset();
            }
        } catch (error) {
            console.error('Error saving goal:', error);
        }
    });

    loadGoals();
</script>
</body>

</html>