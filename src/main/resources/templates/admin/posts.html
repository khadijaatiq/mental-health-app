<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Manage Posts</title>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
</head>

<body>

<nav class="navbar">
    <div class="logo">MindTrack Admin</div>
    <div class="nav-links">
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/resources">Resources</a>
        <a href="/admin/board">Board</a>
        <a href="/admin/moods">Moods</a>
        <a href="/admin/crisis">Crisis</a>
        <a href="/admin/reports">Reports</a>
        <a href="/admin/settings">Settings</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="container">
    <h2>Manage Posts</h2>

    <table id="postsTable" class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>User</th>
            <th>Title</th>
            <th>Created</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    function logout() {
        document.cookie = "JWT=; expires=Thu, 01 Jan 1970; path=/;";
        window.location.href = "/login";
    }

    function getJwt() {
        return document.cookie.split("; ")
            .find(r => r.startsWith("JWT="))
            ?.split("=")[1];
    }

    async function loadPosts() {
        const res = await fetch("/api/admin/posts", {
            headers: { "Authorization": "Bearer " + getJwt() }
        });

        if (!res.ok) {
            alert("Session expired. Please log in again.");
            window.location.href = "/admin/login";
            return;
        }

        const data = await res.json();
        const tbody = document.querySelector("#postsTable tbody");
        tbody.innerHTML = "";

        data.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.userName}</td>
                    <td>${p.title}</td>
                    <td>${p.createdAt}</td>
                    <td>
                        <button class="btn-danger" onclick="deletePost(${p.id})">Delete</button>
                    </td>
                </tr>`;
        });
    }

    async function deletePost(id) {
        if (!confirm("Are you sure you want to delete this post?")) return;

        const res = await fetch(`/api/admin/posts/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + getJwt() }
        });

        if (res.ok) {
            loadPosts();
        } else {
            alert("Failed to delete.");
        }
    }

    loadPosts();
</script>

</body>
</html>
