<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Manage Posts</title>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
</head>
<body>
<nav class="navbar">
    <div class="logo">MindTrack Admin</div>
    <div class="nav-links">
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/resources">Resources</a>
        <a href="/admin/board">Board</a>
        <a href="/admin/moods">Moods</a>
        <a href="/admin/crisis">Crisis</a>
        <a href="/admin/reports">Reports</a>
        <a href="/admin/settings">Settings</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="container">
    <h2>Manage Posts</h2>
    <table id="postsTable" class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>User</th>
            <th>Content</th>
            <th>Created</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    function logout() {
        document.cookie = "JWT=; expires=Thu, 01 Jan 1970; path=/;";
        window.location.href = "/login";
    }

    function getJwt() {
        return document.cookie.split("; ")
            .find(r => r.startsWith("JWT="))
            ?.split("=")[1];
    }

    let allPosts = [];
    let allUsers = [];

    // Load users
    async function loadUsers() {
        try {
            const res = await fetch("/api/admin/users", { credentials: "include" });
            if (!res.ok) throw new Error("Failed to load users");
            allUsers = await res.json();
        } catch (err) {
            console.error(err);
            alert("Error loading users.");
        }
    }

    // Map user_id to username
    function getUsername(user_id) {
        const user = allUsers.find(u => Number(u.id) === Number(user_id));
        return user ? user.username : "Unknown";
    }
    function getCreatedAt(post) {
    if (!post.createdAt && !post.created_at) return "";
    const rawDate = post.createdAt || post.created_at;
    const d = new Date(rawDate);
    return isNaN(d.getTime()) ? rawDate : d.toLocaleString();
    }

    // Load posts
    async function loadPosts() {
        try {
            await loadUsers();
            const res = await fetch("/api/admin/posts", { credentials: "include" });
            if (!res.ok) throw new Error("Failed to load posts");
            allPosts = await res.json();
            renderPosts(allPosts);
        } catch (err) {
            console.error(err);
            alert("Error loading posts. Please try again.");
        }
    }

    // Render posts
function renderPosts(posts) {
    const tbody = document.querySelector("#postsTable tbody");
    if (posts.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:gray;">No posts found.</td></tr>`;
        return;
    }

    tbody.innerHTML = posts.map(p => {
        let createdDate = p.createdAt ? new Date(p.createdAt).toLocaleString() : "";
        return `
            <tr>
                <td>${p.id}</td>
                <td>${p.user ? p.user.username : "Unknown"}</td>
                <td>${p.content || ""}</td>
                <td>${createdDate}</td>
                <td>
                    <button class="btn-flag" onclick="flagPost(${p.id})">
                        ${p.flagged ? "Flagged" : "Flag"}
                    </button>
                    <button class="btn-danger" onclick="deletePost(${p.id})">Delete</button>
                </td>
            </tr>
        `;
    }).join("");
}

async function flagPost(id) {
    const reason = prompt("Enter flag reason:");
    if (!reason) return;

    await fetch(`/api/admin/posts/${id}/flag`, {
        method: "PATCH",
        headers: {
            "Authorization": "Bearer " + getJwt(),
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ reason })
    });

    loadPosts();
}




    // Delete post
    async function deletePost(id) {
        const reason = prompt("Enter deletion reason:");
        if (!reason) return;

        try {
            const res = await fetch(`/api/admin/posts/${id}`, {
                method: "DELETE",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ reason })
            });
            if (!res.ok) throw new Error("Failed to delete post");
            loadPosts();
        } catch (err) {
            console.error(err);
            alert("Error deleting post");
        }
    }

    // Initial load
    loadPosts();
</script>

</body>
</html>
