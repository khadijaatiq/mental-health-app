<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>User Management - MindTrack Admin</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/admin-dashboard.css">
</head>

<body>

<nav class="navbar">
    <div class="logo">MindTrack Admin</div>
    <div class="nav-links">
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/users">Users</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="container">

    <div class="header">
        <h2>User Management</h2>
        <button class="btn-export" onclick="exportUsers()">Export CSV</button>
    </div>

    <div class="card">
        <table>
            <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>

            <tbody id="usersTable"></tbody>
        </table>
    </div>

</div>

<script>
    function getJwt() {
        return document.cookie.split("; ").find(r => r.startsWith("JWT="))?.split("=")[1];
    }

    async function loadUsers() {
        const res = await fetch("/api/admin/users", {
            credentials: "include"
        });

        const users = await res.json();
        const filteredUsers = users.filter(u => u.roles && u.roles.includes("ROLE_USER"));
        const tbody = document.getElementById("usersTable");

        tbody.innerHTML = filteredUsers.map(u => `
            <tr>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td>
                    <span class="badge ${u.blocked ? 'badge-danger' : 'badge-success'}">
                        ${u.blocked ? "Blocked" : "Active"}
                    </span>
                </td>
                <td class="actions">
                    <button class="btn-warning" onclick="toggleBlock(${u.id}, ${!u.blocked})">
                        ${u.blocked ? "Unblock" : "Block"}
                    </button>
                    <button class="btn-danger" onclick="deleteUser(${u.id})">Delete</button>
                </td>
            </tr>
        `).join("");
    }

    async function toggleBlock(id, blocked) {
        await fetch(`/api/admin/users/${id}/block`, {
            method: "PATCH",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ blocked })
        });
        loadUsers();
    }


    async function deleteUser(id) {
        await fetch(`/api/admin/users/${id}`, {
            method: "DELETE",
            credentials: "include"
        });
        loadUsers();
    }


    function exportUsers() {
        window.location.href = "/api/admin/export/users";
    }

    function logout() {
        document.cookie = "JWT=; expires=Thu, 01 Jan 1970; path=/;";
        window.location.href = '/login';
    }

    loadUsers();
</script>

</body>
</html>
