<!DOCTYPE html>
<html lang="en">

<head>
    <title>Admin - Reports & Analytics - MindTrack</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css/users.css">
    <style>

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 1rem;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-list::-webkit-scrollbar {
            width: 8px;
        }

        .activity-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .activity-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .activity-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }



    </style>
</head>

<body>

<nav class="navbar">
    <div class="logo">MindTrack Admin</div>
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </button>
    <div class="nav-links">
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="app-layout">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-nav">
            <a href="/admin/dashboard" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>Dashboard</a>
            <a href="/admin/resources" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>Resources</a>
            <a href="/admin/board" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>Moderate Board</a>
            <a href="/admin/crisis" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Crisis Alerts</a>
            <a href="/admin/reports" class="sidebar-link active"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>Reports</a>
            <a href="/admin/settings" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>Settings</a>
            <a href="/admin/users" class="sidebar-link"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Users</a>
        </div>
    </aside>

    <main class="main-content">
        <h2 class="page-title">Reports & Analytics</h2>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Posts</div>
                <div class="stat-value" id="totalPosts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Flagged Posts</div>
                <div class="stat-value" id="flaggedPosts">0</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <!-- Line Chart -->
            <div class="card">
                <div class="filters">
                    <h3>Activity Trends</h3>
                    <select id="timeRange" onchange="loadTrends()" style="margin-left: auto;">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <h3>Recent Activity</h3>
                <div class="activity-list" id="activityList">
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Breakdown Chart -->
        <div class="card" style="margin-bottom: 2rem;">
            <h3>Activity Breakdown</h3>
            <div class="chart-wrapper">
                <canvas id="breakdownChart"></canvas>
            </div>
        </div>

        <!-- Exports -->
        <div class="card">
            <h3>Data Exports</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Download system-wide data for analysis or backup purposes.
            </p>

            <div class="export-section">
                <button onclick="exportData('system')">Full System Export</button>
                <button class="btn-success" onclick="exportData('moods')">Mood Logs</button>
                <button class="btn-danger" onclick="exportData('stress')">Stress Logs</button>
                <button class="btn-warning" onclick="exportData('users')">User List</button>
            </div>
        </div>
    </main>
</div>
<script>
    let trendsChart = null;
    let breakdownChart = null;

    function logout() {
        document.cookie = "JWT=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = '/login';
    }

    // Load Stats
    async function loadStats() {
        try {
            const response = await fetch('/api/admin/stats');
            if (response.ok) {
                const stats = await response.json();
                document.getElementById('totalUsers').textContent = stats.userCount;
                document.getElementById('totalPosts').textContent = stats.postCount;
                document.getElementById('flaggedPosts').textContent = stats.flaggedCount;
                document.getElementById('activeAlerts').textContent = stats.alertCount;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // Load Trends
    async function loadTrends() {
        try {
            const days = document.getElementById('timeRange').value;
            const response = await fetch(`/api/admin/stats/trends?days=${days}`);

            if (response.ok) {
                const data = await response.json();
                renderTrendsChart(data);
                renderBreakdownChart(data);
            }
        } catch (error) {
            console.error('Error loading trends:', error);
        }
    }

    function renderTrendsChart(data) {
        if (trendsChart) trendsChart.destroy();

        const ctx = document.getElementById('trendsChart').getContext('2d');
        trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Logins',
                        data: data.logins,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Posts',
                        data: data.posts,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Journals',
                        data: data.journals,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Moods',
                        data: data.moods,
                        borderColor: '#ec4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#1e293b',
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12,
                        titleColor: '#f8fafc',
                        bodyColor: '#94a3b8'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    }
                }
            }
        });
    }

    function renderBreakdownChart(data) {
        if (breakdownChart) breakdownChart.destroy();

        const totals = {
            logins: data.logins.reduce((a, b) => a + b, 0),
            posts: data.posts.reduce((a, b) => a + b, 0),
            journals: data.journals.reduce((a, b) => a + b, 0),
            moods: data.moods.reduce((a, b) => a + b, 0),
            goals: data.goals.reduce((a, b) => a + b, 0),
            habits: data.habits.reduce((a, b) => a + b, 0),
            stress: data.stress.reduce((a, b) => a + b, 0)
        };

        const ctx = document.getElementById('breakdownChart').getContext('2d');
        breakdownChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Logins', 'Posts', 'Journals', 'Moods', 'Goals', 'Habits', 'Stress'],
                datasets: [{
                    label: 'Total Activities',
                    data: [
                        totals.logins,
                        totals.posts,
                        totals.journals,
                        totals.moods,
                        totals.goals,
                        totals.habits,
                        totals.stress
                    ],
                    backgroundColor: [
                        'rgba(99, 102, 241, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(20, 184, 166, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    }
                }
            }
        });
    }

    // Load Activity
    async function loadActivity() {
        try {
            const response = await fetch('/api/admin/activity');

            if (response.ok) {
                const activities = await response.json();

                if (activities.length === 0) {
                    document.getElementById('activityList').innerHTML =
                        '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No recent activity</div>';
                    return;
                }

                document.getElementById('activityList').innerHTML = activities.map(a => `
                    <div class="activity-item">
                        <div class="activity-info">
                            <div class="activity-user">${a.user ? a.user.username : 'System'}</div>
                            <div class="activity-action">${formatAction(a.action)}</div>
                        </div>
                        <div class="activity-time">${formatTime(a.timestamp)}</div>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading activity:', error);
            document.getElementById('activityList').innerHTML =
                '<div style="text-align: center; padding: 2rem; color: var(--danger);">Failed to load activities</div>';
        }
    }

    function formatAction(action) {
        const actionMap = {
            'LOGIN': 'Logged in',
            'POST_CREATED': 'Created a post',
            'JOURNAL_CREATED': 'Created journal entry',
            'MOOD_LOGGED': 'Logged mood',
            'GOAL_CREATED': 'Created goal',
            'HABIT_CREATED': 'Created habit',
            'STRESS_LOGGED': 'Logged stress'
        };
        return actionMap[action] || action;
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
        return date.toLocaleDateString();
    }

    function exportData(type) {
        window.location.href = `/api/admin/export/${type}`;
    }

    // Initialize
    window.addEventListener('load', () => {
        loadStats();
        loadTrends();
        loadActivity();

        // Refresh activity every 30 seconds
        setInterval(loadActivity, 30000);
    });
</script>


</body>
</html>