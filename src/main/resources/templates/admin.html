<!DOCTYPE html>
<html lang="en">

<head>
    <title>Admin Dashboard - MindTrack</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/users.css">
</head>

<body>
<nav class="navbar">
    <div class="logo">MindTrack Admin</div>
    <div class="nav-links">
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<div class="container">
    <div class="actions" style="margin-bottom: 2rem;">
        <button class="btn-primary" onclick="exportSystemData()">Export System Data</button>
        <button class="btn-warning" onclick="triggerBackup()">Backup Database</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="userCount">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Posts</div>
            <div class="stat-value" id="totalPosts">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active Alerts</div>
            <div class="stat-value" id="totalAlerts">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Flagged Posts</div>
            <div class="stat-value" id="flaggedCount">-</div>
        </div>
    </div>

    <!-- Global Settings -->
    <div class="control-panel">
        <h3 class="section-title">Global Settings: Check-in Questions</h3>
        <div class="control-group">
            <input type="text" id="newQuestion" placeholder="Enter new reflection question..." />
            <button class="btn-success" onclick="addQuestion()">Add Question</button>
        </div>
        <div id="questionsList"><!-- Questions loaded here --></div>
    </div>

    <div class="grid-2">
        <!-- User Management -->
        <div>
            <h3 class="section-title">User Management</h3>
            <div class="list-container" id="usersList"><!-- Users loaded here --></div>
        </div>

        <!-- Crisis Alerts -->
        <div>
            <h3 class="section-title">‚ö†Ô∏è Crisis Alerts</h3>
            <div class="list-container" id="alertsList"><!-- Alerts loaded here --></div>
        </div>
    </div>

    <!-- Flagged Content -->
    <div>
        <h3 class="section-title">üö© Flagged Content</h3>
        <div class="list-container" id="flaggedList"><!-- Flagged posts loaded here --></div>
    </div>
</div>

<script>
    function logout() {
        document.cookie = "JWT=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        window.location.href = '/login';
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/admin/stats');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('userCount').textContent = data.userCount;
                document.getElementById('totalPosts').textContent = data.postCount;
                document.getElementById('totalAlerts').textContent = data.alertCount;
                document.getElementById('flaggedCount').textContent = data.flaggedCount;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            if (response.ok) {
                const users = await response.json();
                const list = document.getElementById('usersList');
                list.innerHTML = users.map(user => `
                        <div class="list-item">
                            <div class="item-header">
                                <strong>${user.username}</strong>
                                <span class="badge ${user.blocked ? 'badge-danger' : 'badge-success'}">${user.blocked ? 'Blocked' : 'Active'}</span>
                            </div>
                            <div class="item-content">
                                Email: ${user.email}<br>
                                Role: ${user.roles ? Array.from(user.roles).join(', ') : 'USER'}
                            </div>
                            <div class="actions">
                                <button class="btn-warning" onclick="toggleBlock(${user.id}, ${!user.blocked})">${user.blocked ? 'Unblock' : 'Block'}</button>
                                <button class="btn-primary" onclick="changeRole(${user.id})">Change Role</button>
                            </div>
                        </div>
                    `).join('');
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    async function toggleBlock(id, blocked) {
        if (!confirm(`Are you sure you want to ${blocked ? 'block' : 'unblock'} this user?`)) return;

        await fetch(`/api/admin/users/${id}/block`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({blocked})
        });
        loadUsers();
    }

    async function changeRole(id) {
        const role = prompt("Enter new role (USER or ADMIN):");
        if (role && (role === 'USER' || role === 'ADMIN')) {
            await fetch(`/api/admin/users/${id}/role`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role})
            });
            loadUsers();
        }
    }

    async function loadQuestions() {
        const response = await fetch('/api/admin/settings/checkin-questions');
        if (response.ok) {
            const questions = await response.json();
            document.getElementById('questionsList').innerHTML = questions.map(q => `
                    <div class="list-item" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>${q}</span>
                        <button class="btn-danger" onclick="removeQuestion('${q}')">Remove</button>
                    </div>
                `).join('');
        }
    }

    async function addQuestion() {
        const input = document.getElementById('newQuestion');
        const question = input.value.trim();
        if (question) {
            await fetch('/api/admin/settings/checkin-questions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({question})
            });
            input.value = '';
            loadQuestions();
        }
    }

    async function removeQuestion(question) {
        if (!confirm('Remove this question?')) return;
        await fetch('/api/admin/settings/checkin-questions', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({question})
        });
        loadQuestions();
    }

    async function exportSystemData() {
        window.location.href = '/api/admin/export/system';
    }
</script>